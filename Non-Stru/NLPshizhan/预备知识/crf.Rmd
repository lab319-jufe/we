---
title: "CRF"
output:
  html_document: default
  pdf_document: default
---

# 条件随机场

## CRF模型的应用

假设我们有Bob一天从早到晚的一系列照片，Bob想考考我们，要我们猜这一系列的每张照片对应的活动，比如: 工作的照片，吃饭的照片，唱歌的照片等等。一个比较直观的办法就是，我们找到Bob之前的日常生活的一系列照片，然后找Bob问清楚这些照片代表的活动标记，这样我们就可以用监督学习的方法来训练一个分类模型，比如逻辑回归，接着用模型去预测这一天的每张照片最可能的活动标记。


这种办法虽然是可行的，但是却忽略了一个重要的问题，就是这些照片之间的顺序其实是有很大的时间顺序关系的，而用上面的方法则会忽略这种关系。比如我们现在看到了一张Bob闭着嘴的照片，那么这张照片我们怎么标记Bob的活动呢？比较难去打标记。但是如果我们有Bob在这一张照片前一点点时间的照片的话，那么这张照片就好标记了。如果在时间序列上前一张的照片里Bob在吃饭，那么这张闭嘴的照片很有可能是在吃饭咀嚼。而如果在时间序列上前一张的照片里Bob在唱歌，那么这张闭嘴的照片很有可能是在唱歌。


为了让我们的分类器表现的更好，可以在标记数据的时候，可以考虑相邻数据的标记信息。这一点，是普通的分类器难以做到的。而这一块，也是CRF比较擅长的地方。


在实际应用中，自然语言处理中的词性标注(POSTagging)就是非常适合CRF使用的地方。词性标注的目标是给出一个句子中每个词的词性（名词，动词，形容词等）。而这些词的词性往往和上下文的词的词性有关，因此，使用CRF来处理是很适合的，当然CRF不是唯一的选择，也有很多其他的词性标注方法。


## 从随机场到马尔科夫随机场

首先，介绍什么是随机场。随机场是由若干个位置组成的整体，当给每一个位置中按照某种分布随机赋予一个值之后，其全体就叫做随机场。

例子：假如我们有一个十个词形成的句子需要做词性标注。这十个词每个词的词性可以在我们已知的词性集合（名词，动词...)中去选择。当我们为每个词选择完词性后，这就形成了一个随机场。


了解了随机场，再来介绍马尔科夫随机场。马尔科夫随机场是随机场的特例，它假设随机场中某一个位置的赋值仅仅与和它相邻的位置的赋值有关，和与其不相邻的位置的赋值无关。


例子：　如果我们假设所有词的词性只和它相邻的词的词性有关时，这个随机场就特化成一个马尔科夫随机场。比如第三个词的词性除了与自己本身的位置有关外，只与第二个词和第四个词的词性有关。


## 从马尔科夫随机场到条件随机场


CRF是马尔科夫随机场的特例，它假设马尔科夫随机场中只有X和Y两种变量，X一般是给定的，而Y一般是在给定X的条件下我们的输出。这样马尔科夫随机场就特化成了条件随机场。在我们十个词的句子词性标注的例子中，X是词，Y是词性。因此，如果我们假设它是一个马尔科夫随机场，那么它也就是一个CRF。


对于CRF，我们给出准确的数学语言描述：设X与Y是随机变量，P(Y|X)是给定X时Y的条件概率分布，若随机变量Y构成的是一个马尔科夫随机场，则称条件概率分布P(Y|X)是条件随机场。

## 从条件随机场到线性链条件随机场

注意在CRF的定义中，我们并没有要求X和Y有相同的结构。而实现中，我们一般都假设X和Y有相同的结构，即:
$$X=(X1,X2,...Xn),Y=(Y1,Y2,...Yn)$$

我们一般考虑如下图所示的结构：X和Y有相同的图结构的CRF就构成了线性链条件随机场(Linear chain Conditional Random Fields,以下简称 linear-CRF)。



![](https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1582047501575&di=5ed44d23c030d3de29530d7210662094&imgtype=0&src=http%3A%2F%2Fimage.codes51.com%2FArticle%2Fimage%2F20160525%2F20160525191705_2928.png)

linear-CRF的数学定义：

设X=(X1,X2,...Xn),Y=(Y1,Y2,...Yn)均为线性链表示的随机变量序列，在给定随机变量序列X的情况下，随机变量Y的条件概率分布P(Y|X)构成条件随机场，即满足马尔科夫性：
$$P(Yi|X,Y1,Y2,...Yn)=P(Yi|X,Yi−1,Yi+1)$$
则称P(Y|X)为线性链条件随机场。　


## 线性链条件随机场的参数化形式

在linear-CRF中，特征函数分为两类，第一类是定义在Y节点上的节点特征函数，称为状态特征，这类特征函数只和当前节点有关，记为：


$$s_l(y_i,x,i),l=1,2,...L$$


其中L是定义在该节点的节点特征函数的总个数，i是当前节点在序列的位置。

第二类是定义在Y上下文的局部特征函数，称为转移特征，这类特征函数只和当前节点和上一个节点有关，记为：

$$t_k(y_{i−1},y_i,x,i),k=1,2,...K$$

其中K是定义在该节点的局部特征函数的总个数，i是当前节点在序列的位置。之所以只有上下文相关的局部特征函数，没有不相邻节点之间的特征函数，是因为我们的linear-CRF满足马尔科夫性。

无论是节点特征函数还是局部特征函数，它们的取值只能是0或者1。即满足特征条件或者不满足特征条件。同时，我们可以为每个特征函数赋予一个权值，用以表达我们对这个特征函数的信任度。假设$t_k$的权重系数是$λ_k,s_l$的权重系数是$μ_l$,则linear-CRF由我们所有的$t_k,λ_k,s_l,μ_l$共同决定。

此时我们得到了linear-CRF的参数化形式如下：



$$P(y|x)=\frac{1}{Z(x)}exp(\sum_{i,k}λ_kt_k(y_{i−1},y_i,x,i)+\sum_{i,l}μ_ls_l(y_i,x,i))$$

其中，Z(x)为规范化因子：

$$Z(x)=\sum_{y}exp(\sum_{i,k}λ_kt_k(y_{i−1},y_i,x,i)+\sum_{i,l}μ_ls_l(y_i,x,i))$$

## 线性链条件随机场实例


假设输入X=(X1,X2,X3),输出的序列为Y=(Y1,Y2,Y3),其中$Y∈{1，2}$

这里只标记出取值为1的特征函数如下：

$$
\begin{aligned}
t1&=t1(yi−1=1,yi=2,x,i),i=2,3,λ1=1 \\
t2&=t2(y1=1,y2=1,x,2),λ2=0.5\\
t3&=t3(y2=2,y3=1,x,3),λ3=1\\
t4&=t4(y1=2,y2=1,x,2),λ4=1\\
t5&=t5(y2=2,y3=2,x,3),λ5=0.2\\
s1&=s1(y1=1,x,1),μ1=1\\
s2&=s2(yi=2,x,i),i=1,2,μ2=0.5\\
s3&=s3(yi=1,x,i),i=2,3,μ3=0.8\\
s4&=s4(y3=2,x,3)μ4=0.5
\end{aligned}
$$


求标记(1,2,2)的非规范化概率。

利用linear-CRF的参数化公式，我们有：

$$P(y|x)∝exp(\sum_{k=1}^5λ_k\sum_{i=2}^3t_k(y_{i−1},y_i,x,i)+\sum_{l=1}^4μ_l\sum_{i=1}^3s_l(y_i,x,i)]$$
带入(1,2,2)我们有：
$$P(y1=1,y2=2,y3=2|x)∝exp(3.2)$$



